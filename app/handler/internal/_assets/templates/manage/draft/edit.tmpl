{{define "title"}}Edit Draft{{end}}

{{define "header"}}
Edit Draft
{{end}}

{{define "page_template"}}
<form method="post" action="/manage/draft/edit/{{ .Draft.Key.Name }}" name="updateForm">

<table class="mdl-data-table mdl-js-data-table mdl-shadow--2dp" width="100%">
  <tbody>
    <tr>
      <td class="mdl-data-table__cell--non-numeric">
        <div class="mdl-textfield mdl-js-textfield">
          <input class="mdl-textfield__input" type="text" id="draftName" name="name" value="{{ .Draft.Name }}">
          <label class="mdl-textfield__label" for="draftName">Name...</label>
        </div>
      </td>
    </tr>

    <tr>
      <td class="mdl-data-table__cell--non-numeric">
<table class="mdl-data-table mdl-js-data-table mdl-shadow--2dp">
  <thead>
    <tr>
      <th class="mdl-data-table__cell--non-numeric">Name</th>
      <th style="width:240px;">Create</th>
      <th style="width:50px;"> </th>
      <th style="width:50px;"> </th>
      <th style="width:100px;"> </th>
    </tr>
  </thead>

  <tbody id="seqBody">
{{ range $i,$v := .DraftPages }}
    <tr class="seqRow" data-index="{{ $i }}" data-id="{{.Key.Name}}" data-version="{{.Version}}">
      <td class="mdl-data-table__cell--non-numeric">
        <a href="/manage/page/{{ .PageID}}" target="_page_editor">{{ .Name }}</a>
      </td>
      <td>{{convertDate .CreatedAt}}</td>

      <td>
        <button class="mdl-button mdl-js-button mdl-button--icon upBtn">
            <i class="material-icons">arrow_upward</i>
        </button>
      </td>
      <td>
        <button class="mdl-button mdl-js-button mdl-button--icon downBtn">
            <i class="material-icons">arrow_downward</i>
        </button>
      </td>
      <td>
        <button class="mdl-button mdl-js-button mdl-button--icon mdl-button--accent removeBtn">
          <i class="material-icons">delete_forever</i>
        </button>
      </td>
    </tr>
{{ end }}
  </tbody>
</table>

      </td>
    </tr>

    <tr>
      <td>
        <button type="button" id="updateBtn" class="mdl-button mdl-js-button mdl-button--raised mdl-button--primary">
          <span class="material-icons">save</span>
        </button>
      </td>
    </tr>
  </tbody>
</table>

  <input type="hidden" name="version" value="{{ .Draft.Version }}">
  <input type="hidden" id="ids" name="ids" value="">
  <input type="hidden" id="versions" name="versions" value="">

</form>

<script>

  function moveRow(src,target) {
    var seqRows = document.querySelectorAll('tr.seqRow');
    var srcElm;
    var targetElm;
    if ( target < 0 || target >= (seqRows.length) ) {
      return;
    }

    for (var i=0; i< seqRows.length; i++) {
      var addElm = seqRows[i];
      if ( i == src )  {
         addElm.setAttribute("data-index",target);
         srcElm = addElm;
      } else if ( i == target )  {
         addElm.setAttribute("data-index",src);
         targetElm = addElm;
      }
    }

    var elm = document.querySelector('#seqBody');
    //空にする
    while (elm.firstChild) elm.removeChild(elm.firstChild);

    for (var i=0; i< seqRows.length; i++) {
      var addElm = seqRows[i];
      if ( i == src )  {
        addElm = targetElm;
      } else if ( i == target )  {
        addElm = srcElm;
      }
      elm.appendChild(addElm);
    }
  }

  var updateBtn = document.querySelector('#updateBtn');
  updateBtn.addEventListener('click', function() {

    var nameTag = document.querySelector('#draftName');
    if ( nameTag.value == "" ) {
      alertFes("Edit Name!");
      return;
    }

    confirmFes("Save Order?",function() {

      var seqRows = document.querySelectorAll('tr.seqRow');
      var ids = "";
      var versions = "";

      for (var i=0; i< seqRows.length; i++) {
        var seqElm = seqRows[i];
        var id = seqElm.getAttribute("data-id");
        var version = seqElm.getAttribute("data-version");
        if ( ids != "" ) {
          ids += ",";
          versions += ",";
        }

        ids += id;
        versions += version;
      }

      var idsForm = document.querySelector('#ids');
      var versionsForm = document.querySelector('#versions');

      idsForm.value = ids;
      versionsForm.value = versions;

      var form = document.forms.updateForm;
      form.submit();
    });
  });

  var upList = document.querySelectorAll('button.upBtn');
  for (var i=0; i< upList.length; i++) {
    upList[i].addEventListener('click', function(e) {
      e.preventDefault();
      var tr = e.target;
      while ( tr.getAttribute("data-index") == null ) {
         tr = tr.parentNode;
      }
      var index = tr.getAttribute("data-index");
      moveRow(index,parseInt(index)-1);
    });
  }

  var downList = document.querySelectorAll('button.downBtn');
  for (var i=0; i< downList.length; i++) {
    downList[i].addEventListener('click', function(e) {
      e.preventDefault();
      var tr = e.target;
      while ( tr.getAttribute("data-index") == null ) {
         tr = tr.parentNode;
      }
      var index = tr.getAttribute("data-index");
      moveRow(index,parseInt(index)+1);
    });
  }

  var removeList = document.querySelectorAll('button.removeBtn');
  for (var i=0; i< removeList.length; i++) {
    removeList[i].addEventListener('click', function(e) {

      e.preventDefault();
      var tr = e.target;
      while ( tr.getAttribute("data-id") == null ) {
         tr = tr.parentNode;
      }

      var id = tr.getAttribute("data-id");

      confirmFes("Delete Draft Page?",function() {
        window.location.href = "/manage/draft/page/delete/" + id;
      });

    });

  }

</script>
{{ end }}
